/*! tvvm v1.0.2 | MIT (c) 2018 float <zexiplus@outlook.com> | https://github.com/zexiplus/TVM#readme */
"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},Dep=function(){function e(){classCallCheck(this,e),this.subs=[]}return createClass(e,[{key:"addSubs",value:function(e){this.subs.push(e)}},{key:"notify",value:function(){this.subs.forEach(function(e){return e.update()})}}]),e}(),Observer=function(){function n(e,t){classCallCheck(this,n),this.observer(e),this.vm=t}return createClass(n,[{key:"observer",value:function(t){var n=this;t&&"object"===(void 0===t?"undefined":_typeof(t))&&Object.keys(t).forEach(function(e){n.observer(t[e]),n.setReactive(t,e)})}},{key:"setReactive",value:function(t,n){var i=t[n],s=this,o=new Dep;Object.defineProperty(t,n,{enumerable:!0,configurable:!0,get:function(){return Dep.target&&o.addSubs(Dep.target),i},set:function(e){e!==t[n]&&(s.observer(e),s.vm.callHook("beforeUpdate"),i=e,o.notify(),s.vm.callHook("updated"))}})}}]),n}(),Watcher=function(){function o(e,t,n,i,s){classCallCheck(this,o),this.vm=e,this.watchTarget=t,this.expr=n,this.bindAttrName=i,this.cb=s,this.value=this.getValAndSetTarget()}return createClass(o,[{key:"getValAndSetTarget",value:function(){var e=(Dep.target=this).getValue(this.watchTarget,this.vm.$data);return Dep.target=null,e}},{key:"getValue",value:function(e,t){return e.split(".").reduce(function(e,t){return e[t]},t)}},{key:"update",value:function(){var e=this.getValue(this.watchTarget,this.vm.$data);this.cb&&this.cb(e,this.bindAttrName,this.expr)}}]),o}(),compileUtil={updateText:function(e,t,n,i){t&&(t.textContent=e)},"t-value":function(e,t,n,i){var s=this;t&&(t.value=e),t.addEventListener("input",function(e){s.setVal(n.$data,i,e.target.value)})},"t-bind":function(e,t,n,i,s){t&&t.setAttribute(s,e)},"t-if":function(e,t,n,i){t&&(t.style.display=e?"block":"none")},"t-show":function(e,t,n,i){var s=window.getComputedStyle(t);t&&(t.style.visibility=e?s:"hidden")},"t-class":function(t,n,e,i){console.log("trigger t class"),Array.isArray(t)?t.forEach(function(e){n.classList.add(e)}):"[object Object]"==={}.toString.call(t)?Object.keys(t).forEach(function(e){t[e]?n.classList.add(e):n.classList.remove(e)}):console.warn("t-class must receive an array or object")},"t-for":function(e,t,n,i,s,o){var a=3+o.indexOf("in"),r=o.slice(a),u=r.split(".").slice(1).join("."),c=o.slice(0,a-4),l=this.getVal(n.$data,u),f=/\{\{([^}]+)\}\}/g;if(!Array.isArray(l))return console.warn("t-for value must be an array");var h=t.parentElement;h.removeChild(t);var d=t.cloneNode(!0);d.setAttribute("t-scope",r),d.setAttribute("t-itemname",c),d.removeAttribute("t-for"),d.setAttribute("t-index",0),d.setAttribute("is-t-for","true"),l.forEach(function(e,t){var n=d.cloneNode(!0);if(n.setAttribute("t-index",t),n.textContent){var i=n.textContent.match(/\{\{([^}]+)\}\}/)[1],s=Function("item","return "+i)(e);n.textContent=n.textContent.replace(f,s)}h.appendChild(n)})},setVal:function(e,t,n){var i=t.split(".");i.reduce(function(e,t){if(i.indexOf(t)!=i.length-1)return e[t];e[t]=n},e)},getVal:function(e,t){return t.split(".").reduce(function(e,t){return e[t]},e)}},privateDirectives=["is-t-for","t-index","t-scope","t-itemname"],Compiler=function(){function i(e,t){if(classCallCheck(this,i),this.el=this.getDOM(e),this.vm=t,this.el){var n=this.toFragment(this.el);this.compile(n),this.el.appendChild(n)}else console.error("can not find element named "+e);this.vm.$el=this.el}return createClass(i,[{key:"compile",value:function(e){var n=this;e.childNodes.forEach(function(e,t){"CODE"!==e.tagName&&(n.isElement(e)?(n.compile(e),n.compileNode(e)):n.isText(e)&&n.compileText(e))})}},{key:"compileText",value:function(n){var i=this,e=/\{\{([^}]+)\}\}/,t=n.textContent;if(e.test(t))if(n.parentElement.getAttribute("t-for")||n.parentElement.getAttribute("is-t-for"));else{var s=t.match(e)[1],o=s.match(/data(\.[a-zA-Z_]+[a-zA-Z_\d]*)+(\(\))*/g),a=/\.([a-zA-Z_]+[a-zA-Z_\d])+(\(\))/,r=Function("data","return "+s)(this.vm.$data);compileUtil.updateText(r,n,this.vm),o=o.map(function(e){var t=e.replace(a,"");return t=t.split(".").slice(1).join("."),new Watcher(i.vm,t,s,null,function(e){var t=Function("data","return "+this.expr)(this.vm.$data);compileUtil.updateText(t,n,this.vm)}),t})}}},{key:"getValue",value:function(e,t){return(e&&e.split(".")).reduce(function(e,t){return e[t]},t)}},{key:"compileNode",value:function(u){var c=this,e=u.getAttributeNames();if(e.filter(function(e){return c.isDirective(e)&&!c.isTFocus(e)}).forEach(function(i){if("t-itemname"!==i&&"is-t-for"!==i){var e=u.getAttribute(i),s=e.split(".").slice(1).join("."),t=null;if(c.isTBind(i)){var n=1+i.indexOf(":");t=i.slice(n),i="t-bind"}new Watcher(c.vm,s,e,t,function(e,t,n){compileUtil[i](e,u,c.vm,s,t,n)});var o=c.getValue(s,c.vm.$data);compileUtil[i]?compileUtil[i](o,u,c.vm,s,t,e):c.isPrivateDirective(i)||c.isEventBinding(i)||console.warn("can't find directive "+i)}}),e.includes("t-index")){var t=u.getAttribute("t-index");u.setAttribute("tabindex",this.vm.focuser.tid),this.vm.focuser.addFocusMap(t,u)}e.filter(this.isEventBinding).forEach(function(e){var i=u.getAttribute(e),t=e.slice(1),s=/\(([^)]+)\)/,o=s.test(i),n=i.replace(s,""),a=c.getValue(n,c.vm);if(u.getAttribute("is-t-for"))u.parentElement.addEventListener(t,function(e){if(e.target.getAttribute("is-t-for"))if(o){i.match(s)[1].split(",").map(function(e){return c.getValue(e.trim(),c.vm.$data)});var t=e.target.getAttribute("t-scope").split(".").slice(1).join("."),n=c.getValue(t,c.vm.$data)[e.target.getAttribute("t-index")];a.call(c.vm,n)}else a.call(c.vm)});else if(o){var r=i.match(s)[1].split(",").map(function(e){return c.getValue(e.trim(),c.vm.$data)});u.addEventListener(t,a.bind.apply(a,[c.vm].concat(toConsumableArray(r))))}else u.addEventListener(t,a.bind(c.vm))})}},{key:"isPrivateDirective",value:function(e){return privateDirectives.includes(e)}},{key:"isEventBinding",value:function(e){return/^@/.test(e)}},{key:"isDirective",value:function(e){return e.includes("t-")||0==e.indexOf(":")}},{key:"isTFocus",value:function(e){return"t-index"===e}},{key:"isTFor",value:function(e){return"t-for"===e}},{key:"isTBind",value:function(e){return/(^t-bind:|^:)/.test(e)}},{key:"getDOM",value:function(e){return this.isElement(e)?e:document.querySelector(e)||null}},{key:"isElement",value:function(e){return 1===e.nodeType}},{key:"isText",value:function(e){return 3===e.nodeType}},{key:"toFragment",value:function(e){for(var t=document.createDocumentFragment(),n=void 0;n=e.firstChild;)t.appendChild(n);return t}}]),i}(),blankFn=function(e,t,n,i){},defaultFocusOptions={circle:{horizontal:!1,vertical:!1},keysMap:{up:{codes:[38,104],handler:blankFn},down:{codes:[40,98],handler:blankFn},left:{codes:[37,100],handler:blankFn},right:{codes:[39,102],handler:blankFn},enter:{codes:[13,32],handler:blankFn},space:{codes:[32],handler:blankFn},home:{codes:[36],handler:blankFn},menu:{codes:[18],handler:blankFn},return:{codes:[27],handler:blankFn},addVolume:{codes:[175],handler:blankFn},subVolume:{codes:[174],handler:blankFn},shutdown:{codes:[71],handler:blankFn}},keysMapMergeCoverage:!1},Focuser=function(){function n(e,t){classCallCheck(this,n),this.tid=0,this.init(e,t),this.bindKeyEvent()}return createClass(n,[{key:"init",value:function(e,t){var n=this;this.focusElementMap={},this.indexMap=[],this.focusOptions=Object.assign({},defaultFocusOptions,t.focus);var i=void 0,s=void 0;if(this.focusOptions.defaultFocusIndex){var o=t.focus&&t.focus.defaultFocusIndex.split("-");i=+o[0],s=+o[1]}this.focusState={currentIndexString:t.focus&&t.focus.defaultFocusIndex||"",currentRowIndex:i,currentColIndex:s},this.keysMap=this.focusOptions.keysMap,t.focus&&t.focus.keysMap&&(this.focusOptions.keysMapMergeCoverage?this.keysMap=Object.assign({},this.keysMap,t.focus.keysMap):Object.keys(this.keysMap).forEach(function(e){n.keysMap[e].codes=defaultFocusOptions.keysMap[e]?t.focus.keysMap[e].codes?[].concat(toConsumableArray(new Set(defaultFocusOptions.keysMap[e].codes.concat(t.focus.keysMap[e].codes)))):n.keysMap[e].codes:t.focus.keysMap[e].codes})),(e.focuser=this).vm=e}},{key:"execCommand",value:function(t){var n=this;Object.keys(this.keysMap).forEach(function(e){n.keysMap[e].codes.includes(t.keyCode)&&n.move(e,t)})}},{key:"bindKeyEvent",value:function(){window.addEventListener("keydown",this.keyDownHandler.bind(this))}},{key:"keyDownHandler",value:function(e){this.execCommand(e)}},{key:"addFocusMap",value:function(e,t){var n=this;this.tid++,e.split(/,\s*/).forEach(function(e){if(e in n.focusElementMap)return console.warn("t-focus should be unique in one TVVM page but t-focus="+e+" has already exist");n.focusElementMap[e]=t})}},{key:"setFocus",value:function(e){if(e in this.focusElementMap){var t=e.split("-"),n=+t[0],i=+t[1],s=this.focusElementMap[e];if("true"===s.getAttribute("real-focus"))s.focus();else s.classList.add(this.focusOptions.activeClass);this.focusState.currentIndexString=e,this.focusState.currentFocusElement=this.focusElementMap[e],this.focusState.currentRowIndex=n,this.focusState.currentColIndex=i}}},{key:"removeFocus",value:function(e){if(e in this.focusElementMap){var t=this.focusElementMap[e];if("true"===t.getAttribute("real-focus"))t.blur();else t.classList.remove(this.focusOptions.activeClass)}}},{key:"generateIndexMap",value:function(){var s=this;Object.keys(this.focusElementMap).forEach(function(e){var t=e.split("-"),n=t[0],i=t[1];void 0===s.indexMap[n]?s.indexMap[n]=[i]:s.indexMap[n].push(i)}),this.indexMap=this.indexMap.map(function(e){return e.sort(function(e,t){return e-t})}),void 0!==this.focusOptions.defaultFocusIndex?this.setFocus(this.focusOptions.defaultFocusIndex):0!==this.indexMap.length?this.setFocus([0,this.indexMap[0][0]].join("-")):window.removeEventListener("keydown",this.keyDownHandler)}},{key:"isBoundary",value:function(){}},{key:"isTopBoundary",value:function(){var e=this.focusState.currentRowIndex,t=this.focusState.currentColIndex;if(0===e)return!0;for(var n=[--e,t].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[--e,t].join("-");return 0>=++e}},{key:"isLeftBoundary",value:function(){var e=this.focusState.currentRowIndex,t=this.focusState.currentColIndex;if(t===this.indexMap[e][0])return!0;for(var n=[e,--t].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[e,--t].join("-");return this.indexMap[e][0]>=++t}},{key:"isRightBoundary",value:function(){var e=this.focusState.currentRowIndex,t=this.focusState.currentColIndex;if(t===this.indexMap[e][this.indexMap[e].length-1])return!0;for(var n=[e,++t].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[e,++t].join("-");return--t>=this.indexMap[e][this.indexMap[e].length-1]}},{key:"isBottomBoundary",value:function(){var e=this.focusState.currentRowIndex,t=this.focusState.currentColIndex;if(e===this.indexMap.length-1)return!0;for(var n=[++e,t].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[++e,t].join("-");return--e>=this.indexMap.length-1}},{key:"moveUp",value:function(e,t,n){if(this.keysMap.up.handler&&this.keysMap.up.handler(e,t,n),this.isTopBoundary()){if(this.focusOptions.circle.vertical)this.removeFocus(n),this.setFocus([this.indexMap.length-1,this.focusState.currentColIndex].join("-"))}else{this.removeFocus(n);for(var i=this.focusState.currentRowIndex-1,s=this.focusState.currentColIndex,o=[i,s].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[o];)o=[--i,s].join("-");this.setFocus(o=[i,s].join("-"))}}},{key:"moveDown",value:function(e,t,n){if(this.keysMap.down.handler&&this.keysMap.down.handler(e,t,n),this.isBottomBoundary()){if(this.focusOptions.circle.vertical){this.removeFocus(n);this.setFocus([0,this.focusState.currentColIndex].join("-"))}}else{this.removeFocus(n);for(var i=this.focusState.currentRowIndex+1,s=this.focusState.currentColIndex,o=[i,s].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[o];)o=[++i,s].join("-");this.setFocus(o=[i,s].join("-"))}}},{key:"moveLeft",value:function(e,t,n){if(this.keysMap.left.handler&&this.keysMap.left.handler(e,t,n),this.isLeftBoundary()){if(this.focusOptions.circle.horizontal){this.removeFocus(n);var i=this.focusState.currentRowIndex;this.setFocus([i,this.indexMap[i][this.indexMap[i].length-1]].join("-"))}}else{this.removeFocus(n);for(var s=this.focusState.currentRowIndex,o=this.focusState.currentColIndex-1,a=[s,o].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[a];)a=[s,--o].join("-");this.setFocus(a=[s,o].join("-"))}}},{key:"moveRight",value:function(e,t,n){if(this.keysMap.right.handler&&this.keysMap.right.handler(e,t,n),this.isRightBoundary()){if(this.focusOptions.circle.horizontal){this.removeFocus(n);var i=this.focusState.currentRowIndex;this.setFocus([i,this.indexMap[i][0]].join("-"))}}else{this.removeFocus(n);for(var s=this.focusState.currentRowIndex,o=this.focusState.currentColIndex+1,a=[s,o].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[a];)a=[s,++o].join("-");this.setFocus(a=[s,o].join("-"))}}},{key:"move",value:function(e,t){Object.assign({},this.keysMap,{up:{handler:this.moveUp},down:{handler:this.moveDown},left:{handler:this.moveLeft},right:{handler:this.moveRight}})[e].handler.call(this,t,this.focusState.currentFocusElement,this.focusState.currentIndexString)}}]),n}(),Lifecycle=function(){function n(e,t){classCallCheck(this,n),this.hooks={},this.init(e,t),t.lifecycle=this,t.callHook=this.callHook.bind(this)}return createClass(n,[{key:"init",value:function(e,n){var i={beforeCreate:e.beforeCreate,created:e.created,beforeMount:e.beforeMount,mounted:e.mounted,beforeUpdate:e.beforeUpdate,updated:e.updated,beforeDestory:e.beforeDestory,destoried:e.destoried};Object.keys(i).forEach(function(e,t){void 0===i[e]&&(i[e]=emptyFn),i[e]=i[e]instanceof Function?i[e].bind(n):(console.warn("lifecycle hooks must be a function"),emptyFn)}),this.hooks=i}},{key:"callHook",value:function(e){this.hooks[e]()}}]),n}();function emptyFn(){}var TVVM=function(){function t(e){classCallCheck(this,t),new Focuser(this,e),new Lifecycle(e.hooks||{},this),this.callHook("beforeCreate"),this.$data="function"==typeof e.data?e.data():e.data,this.methods=e.methods,this.proxy(this.$data,this),this.proxy(e.methods,this),e.el&&(new Observer(this.$data,this),this.callHook("created"),this.callHook("beforeMount"),new Compiler(e.el,this),this.focuser.generateIndexMap(),this.callHook("mounted"))}return createClass(t,[{key:"proxy",value:function(n,e){Object.keys(n).forEach(function(t){Object.defineProperty(e,t,{enumerable:!0,configurable:!0,get:function(){return n[t]},set:function(e){n[t]=e}})})}}]),t}();module.exports=TVVM;