/*! tvvm v1.0.2 | MIT (c) 2018 float <zexiplus@outlook.com> | https://github.com/zexiplus/TVM#readme */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.TVVM=e()}(this,function(){"use strict";var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},s=function(){function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}}(),f=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},a=function(){function t(){r(this,t),this.subs=[]}return s(t,[{key:"addSubs",value:function(t){this.subs.push(t)}},{key:"notify",value:function(){this.subs.forEach(function(t){return t.update()})}}]),t}(),n=function(){function n(t,e){r(this,n),this.observer(t),this.vm=e}return s(n,[{key:"observer",value:function(e){var n=this;e&&"object"===(void 0===e?"undefined":t(e))&&Object.keys(e).forEach(function(t){n.observer(e[t]),n.setReactive(e,t)})}},{key:"setReactive",value:function(e,n){var i=e[n],s=this,o=new a;Object.defineProperty(e,n,{enumerable:!0,configurable:!0,get:function(){return a.target&&o.addSubs(a.target),i},set:function(t){t!==e[n]&&(s.observer(t),s.vm.callHook("beforeUpdate"),i=t,o.notify(),s.vm.callHook("updated"))}})}}]),n}(),l=function(){function o(t,e,n,i,s){r(this,o),this.vm=t,this.watchTarget=e,this.expr=n,this.bindAttrName=i,this.cb=s,this.value=this.getValAndSetTarget()}return s(o,[{key:"getValAndSetTarget",value:function(){var t=(a.target=this).getValue(this.watchTarget,this.vm.$data);return a.target=null,t}},{key:"getValue",value:function(t,e){return t.split(".").reduce(function(t,e){return t[e]},e)}},{key:"update",value:function(){var t=this.getValue(this.watchTarget,this.vm.$data);this.cb&&this.cb(t,this.bindAttrName,this.expr)}}]),o}(),h={updateText:function(t,e,n,i){e&&(e.textContent=t)},"t-value":function(t,e,n,i){var s=this;e&&(e.value=t),e.addEventListener("input",function(t){s.setVal(n.$data,i,t.target.value)})},"t-bind":function(t,e,n,i,s){e&&e.setAttribute(s,t)},"t-if":function(t,e,n,i){e&&(e.style.display=t?"block":"none")},"t-show":function(t,e,n,i){var s=window.getComputedStyle(e);e&&(e.style.visibility=t?s:"hidden")},"t-class":function(e,n,t,i){console.log("trigger t class"),Array.isArray(e)?e.forEach(function(t){n.classList.add(t)}):"[object Object]"==={}.toString.call(e)?Object.keys(e).forEach(function(t){e[t]?n.classList.add(t):n.classList.remove(t)}):console.warn("t-class must receive an array or object")},"t-for":function(t,e,n,i,s,o){var r=3+o.indexOf("in"),a=o.slice(r),u=a.split(".").slice(1).join("."),c=o.slice(0,r-4),f=this.getVal(n.$data,u),l=/\{\{([^}]+)\}\}/g;if(!Array.isArray(f))return console.warn("t-for value must be an array");var h=e.parentElement;h.removeChild(e);var d=e.cloneNode(!0);d.setAttribute("t-scope",a),d.setAttribute("t-itemname",c),d.removeAttribute("t-for"),d.setAttribute("t-index",0),d.setAttribute("is-t-for","true"),f.forEach(function(t,e){var n=d.cloneNode(!0);if(n.setAttribute("t-index",e),n.textContent){var i=n.textContent.match(/\{\{([^}]+)\}\}/)[1],s=Function("item","return "+i)(t);n.textContent=n.textContent.replace(l,s)}h.appendChild(n)})},setVal:function(t,e,n){var i=e.split(".");i.reduce(function(t,e){if(i.indexOf(e)!=i.length-1)return t[e];t[e]=n},t)},getVal:function(t,e){return e.split(".").reduce(function(t,e){return t[e]},t)}},e=["is-t-for","t-index","t-scope","t-itemname"],i=function(){function i(t,e){if(r(this,i),this.el=this.getDOM(t),this.vm=e,this.el){var n=this.toFragment(this.el);this.compile(n),this.el.appendChild(n)}else console.error("can not find element named "+t);this.vm.$el=this.el}return s(i,[{key:"compile",value:function(t){var n=this;t.childNodes.forEach(function(t,e){"CODE"!==t.tagName&&(n.isElement(t)?(n.compile(t),n.compileNode(t)):n.isText(t)&&n.compileText(t))})}},{key:"compileText",value:function(n){var i=this,t=/\{\{([^}]+)\}\}/,e=n.textContent;if(t.test(e))if(n.parentElement.getAttribute("t-for")||n.parentElement.getAttribute("is-t-for"));else{var s=e.match(t)[1],o=s.match(/data(\.[a-zA-Z_]+[a-zA-Z_\d]*)+(\(\))*/g),r=/\.([a-zA-Z_]+[a-zA-Z_\d])+(\(\))/,a=Function("data","return "+s)(this.vm.$data);h.updateText(a,n,this.vm),o=o.map(function(t){var e=t.replace(r,"");return e=e.split(".").slice(1).join("."),new l(i.vm,e,s,null,function(t){var e=Function("data","return "+this.expr)(this.vm.$data);h.updateText(e,n,this.vm)}),e})}}},{key:"getValue",value:function(t,e){return(t&&t.split(".")).reduce(function(t,e){return t[e]},e)}},{key:"compileNode",value:function(u){var c=this,t=u.getAttributeNames();if(t.filter(function(t){return c.isDirective(t)&&!c.isTFocus(t)}).forEach(function(i){if("t-itemname"!==i&&"is-t-for"!==i){var t=u.getAttribute(i),s=t.split(".").slice(1).join("."),e=null;if(c.isTBind(i)){var n=1+i.indexOf(":");e=i.slice(n),i="t-bind"}new l(c.vm,s,t,e,function(t,e,n){h[i](t,u,c.vm,s,e,n)});var o=c.getValue(s,c.vm.$data);h[i]?h[i](o,u,c.vm,s,e,t):c.isPrivateDirective(i)||c.isEventBinding(i)||console.warn("can't find directive "+i)}}),t.includes("t-index")){var e=u.getAttribute("t-index");u.setAttribute("tabindex",this.vm.focuser.tid),this.vm.focuser.addFocusMap(e,u)}t.filter(this.isEventBinding).forEach(function(t){var i=u.getAttribute(t),e=t.slice(1),s=/\(([^)]+)\)/,o=s.test(i),n=i.replace(s,""),r=c.getValue(n,c.vm);if(u.getAttribute("is-t-for"))u.parentElement.addEventListener(e,function(t){if(t.target.getAttribute("is-t-for"))if(o){i.match(s)[1].split(",").map(function(t){return c.getValue(t.trim(),c.vm.$data)});var e=t.target.getAttribute("t-scope").split(".").slice(1).join("."),n=c.getValue(e,c.vm.$data)[t.target.getAttribute("t-index")];r.call(c.vm,n)}else r.call(c.vm)});else if(o){var a=i.match(s)[1].split(",").map(function(t){return c.getValue(t.trim(),c.vm.$data)});u.addEventListener(e,r.bind.apply(r,[c.vm].concat(f(a))))}else u.addEventListener(e,r.bind(c.vm))})}},{key:"isPrivateDirective",value:function(t){return e.includes(t)}},{key:"isEventBinding",value:function(t){return/^@/.test(t)}},{key:"isDirective",value:function(t){return t.includes("t-")||0==t.indexOf(":")}},{key:"isTFocus",value:function(t){return"t-index"===t}},{key:"isTFor",value:function(t){return"t-for"===t}},{key:"isTBind",value:function(t){return/(^t-bind:|^:)/.test(t)}},{key:"getDOM",value:function(t){return this.isElement(t)?t:document.querySelector(t)||null}},{key:"isElement",value:function(t){return 1===t.nodeType}},{key:"isText",value:function(t){return 3===t.nodeType}},{key:"toFragment",value:function(t){for(var e=document.createDocumentFragment(),n=void 0;n=t.firstChild;)e.appendChild(n);return e}}]),i}(),o=function(t,e,n,i){},u={circle:{horizontal:!1,vertical:!1},keysMap:{up:{codes:[38,104],handler:o},down:{codes:[40,98],handler:o},left:{codes:[37,100],handler:o},right:{codes:[39,102],handler:o},enter:{codes:[13,32],handler:o},space:{codes:[32],handler:o},home:{codes:[36],handler:o},menu:{codes:[18],handler:o},return:{codes:[27],handler:o},addVolume:{codes:[175],handler:o},subVolume:{codes:[174],handler:o},shutdown:{codes:[71],handler:o}},keysMapMergeCoverage:!1},c=function(){function n(t,e){r(this,n),this.tid=0,this.init(t,e),this.bindKeyEvent()}return s(n,[{key:"init",value:function(t,e){var n=this;this.focusElementMap={},this.indexMap=[],this.focusOptions=Object.assign({},u,e.focus);var i=void 0,s=void 0;if(this.focusOptions.defaultFocusIndex){var o=e.focus&&e.focus.defaultFocusIndex.split("-");i=+o[0],s=+o[1]}this.focusState={currentIndexString:e.focus&&e.focus.defaultFocusIndex||"",currentRowIndex:i,currentColIndex:s},this.keysMap=this.focusOptions.keysMap,e.focus&&e.focus.keysMap&&(this.focusOptions.keysMapMergeCoverage?this.keysMap=Object.assign({},this.keysMap,e.focus.keysMap):Object.keys(this.keysMap).forEach(function(t){n.keysMap[t].codes=u.keysMap[t]?e.focus.keysMap[t].codes?[].concat(f(new Set(u.keysMap[t].codes.concat(e.focus.keysMap[t].codes)))):n.keysMap[t].codes:e.focus.keysMap[t].codes})),(t.focuser=this).vm=t}},{key:"execCommand",value:function(e){var n=this;Object.keys(this.keysMap).forEach(function(t){n.keysMap[t].codes.includes(e.keyCode)&&n.move(t,e)})}},{key:"bindKeyEvent",value:function(){window.addEventListener("keydown",this.keyDownHandler.bind(this))}},{key:"keyDownHandler",value:function(t){this.execCommand(t)}},{key:"addFocusMap",value:function(t,e){var n=this;this.tid++,t.split(/,\s*/).forEach(function(t){if(t in n.focusElementMap)return console.warn("t-focus should be unique in one TVVM page but t-focus="+t+" has already exist");n.focusElementMap[t]=e})}},{key:"setFocus",value:function(t){if(t in this.focusElementMap){var e=t.split("-"),n=+e[0],i=+e[1],s=this.focusElementMap[t];if("true"===s.getAttribute("real-focus"))s.focus();else s.classList.add(this.focusOptions.activeClass);this.focusState.currentIndexString=t,this.focusState.currentFocusElement=this.focusElementMap[t],this.focusState.currentRowIndex=n,this.focusState.currentColIndex=i}}},{key:"removeFocus",value:function(t){if(t in this.focusElementMap){var e=this.focusElementMap[t];if("true"===e.getAttribute("real-focus"))e.blur();else e.classList.remove(this.focusOptions.activeClass)}}},{key:"generateIndexMap",value:function(){var s=this;Object.keys(this.focusElementMap).forEach(function(t){var e=t.split("-"),n=e[0],i=e[1];void 0===s.indexMap[n]?s.indexMap[n]=[i]:s.indexMap[n].push(i)}),this.indexMap=this.indexMap.map(function(t){return t.sort(function(t,e){return t-e})}),void 0!==this.focusOptions.defaultFocusIndex?this.setFocus(this.focusOptions.defaultFocusIndex):0!==this.indexMap.length?this.setFocus([0,this.indexMap[0][0]].join("-")):window.removeEventListener("keydown",this.keyDownHandler)}},{key:"isBoundary",value:function(){}},{key:"isTopBoundary",value:function(){var t=this.focusState.currentRowIndex,e=this.focusState.currentColIndex;if(0===t)return!0;for(var n=[--t,e].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[--t,e].join("-");return 0>=++t}},{key:"isLeftBoundary",value:function(){var t=this.focusState.currentRowIndex,e=this.focusState.currentColIndex;if(e===this.indexMap[t][0])return!0;for(var n=[t,--e].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[t,--e].join("-");return this.indexMap[t][0]>=++e}},{key:"isRightBoundary",value:function(){var t=this.focusState.currentRowIndex,e=this.focusState.currentColIndex;if(e===this.indexMap[t][this.indexMap[t].length-1])return!0;for(var n=[t,++e].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[t,++e].join("-");return--e>=this.indexMap[t][this.indexMap[t].length-1]}},{key:"isBottomBoundary",value:function(){var t=this.focusState.currentRowIndex,e=this.focusState.currentColIndex;if(t===this.indexMap.length-1)return!0;for(var n=[++t,e].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[++t,e].join("-");return--t>=this.indexMap.length-1}},{key:"moveUp",value:function(t,e,n){if(this.keysMap.up.handler&&this.keysMap.up.handler(t,e,n),this.isTopBoundary()){if(this.focusOptions.circle.vertical)this.removeFocus(n),this.setFocus([this.indexMap.length-1,this.focusState.currentColIndex].join("-"))}else{this.removeFocus(n);for(var i=this.focusState.currentRowIndex-1,s=this.focusState.currentColIndex,o=[i,s].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[o];)o=[--i,s].join("-");this.setFocus(o=[i,s].join("-"))}}},{key:"moveDown",value:function(t,e,n){if(this.keysMap.down.handler&&this.keysMap.down.handler(t,e,n),this.isBottomBoundary()){if(this.focusOptions.circle.vertical){this.removeFocus(n);this.setFocus([0,this.focusState.currentColIndex].join("-"))}}else{this.removeFocus(n);for(var i=this.focusState.currentRowIndex+1,s=this.focusState.currentColIndex,o=[i,s].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[o];)o=[++i,s].join("-");this.setFocus(o=[i,s].join("-"))}}},{key:"moveLeft",value:function(t,e,n){if(this.keysMap.left.handler&&this.keysMap.left.handler(t,e,n),this.isLeftBoundary()){if(this.focusOptions.circle.horizontal){this.removeFocus(n);var i=this.focusState.currentRowIndex;this.setFocus([i,this.indexMap[i][this.indexMap[i].length-1]].join("-"))}}else{this.removeFocus(n);for(var s=this.focusState.currentRowIndex,o=this.focusState.currentColIndex-1,r=[s,o].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[r];)r=[s,--o].join("-");this.setFocus(r=[s,o].join("-"))}}},{key:"moveRight",value:function(t,e,n){if(this.keysMap.right.handler&&this.keysMap.right.handler(t,e,n),this.isRightBoundary()){if(this.focusOptions.circle.horizontal){this.removeFocus(n);var i=this.focusState.currentRowIndex;this.setFocus([i,this.indexMap[i][0]].join("-"))}}else{this.removeFocus(n);for(var s=this.focusState.currentRowIndex,o=this.focusState.currentColIndex+1,r=[s,o].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[r];)r=[s,++o].join("-");this.setFocus(r=[s,o].join("-"))}}},{key:"move",value:function(t,e){Object.assign({},this.keysMap,{up:{handler:this.moveUp},down:{handler:this.moveDown},left:{handler:this.moveLeft},right:{handler:this.moveRight}})[t].handler.call(this,e,this.focusState.currentFocusElement,this.focusState.currentIndexString)}}]),n}(),d=function(){function n(t,e){r(this,n),this.hooks={},this.init(t,e),e.lifecycle=this,e.callHook=this.callHook.bind(this)}return s(n,[{key:"init",value:function(t,n){var i={beforeCreate:t.beforeCreate,created:t.created,beforeMount:t.beforeMount,mounted:t.mounted,beforeUpdate:t.beforeUpdate,updated:t.updated,beforeDestory:t.beforeDestory,destoried:t.destoried};Object.keys(i).forEach(function(t,e){void 0===i[t]&&(i[t]=v),i[t]=i[t]instanceof Function?i[t].bind(n):(console.warn("lifecycle hooks must be a function"),v)}),this.hooks=i}},{key:"callHook",value:function(t){this.hooks[t]()}}]),n}();function v(){}return function(){function e(t){r(this,e),new c(this,t),new d(t.hooks||{},this),this.callHook("beforeCreate"),this.$data="function"==typeof t.data?t.data():t.data,this.methods=t.methods,this.proxy(this.$data,this),this.proxy(t.methods,this),t.el&&(new n(this.$data,this),this.callHook("created"),this.callHook("beforeMount"),new i(t.el,this),this.focuser.generateIndexMap(),this.callHook("mounted"))}return s(e,[{key:"proxy",value:function(n,t){Object.keys(n).forEach(function(e){Object.defineProperty(t,e,{enumerable:!0,configurable:!0,get:function(){return n[e]},set:function(t){n[e]=t}})})}}]),e}()});