/*! tvvm v1.0.2 | MIT (c) 2018 float <zexiplus@outlook.com> | https://github.com/zexiplus/TVM#readme */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.TVVM=e()}(this,function(){"use strict";var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},s=function(){function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}}(),f=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},r=function(){function t(){o(this,t),this.subs=[]}return s(t,[{key:"addSubs",value:function(t){this.subs.push(t)}},{key:"notify",value:function(){this.subs.forEach(function(t){return t.update()})}}]),t}(),n=function(){function e(t){o(this,e),this.observer(t)}return s(e,[{key:"observer",value:function(e){var n=this;e&&"object"===(void 0===e?"undefined":t(e))&&Object.keys(e).forEach(function(t){n.observer(e[t]),n.setReactive(e,t)})}},{key:"setReactive",value:function(e,n){var i=e[n],o=this,s=new r;Object.defineProperty(e,n,{enumerable:!0,configurable:!0,get:function(){return r.target&&s.addSubs(r.target),i},set:function(t){t!==e[n]&&(o.observer(t),i=t,s.notify())}})}}]),e}(),a=function(){function i(t,e,n){o(this,i),this.vm=t,this.expr=e,this.cb=n,this.value=this.getValAndSetTarget()}return s(i,[{key:"getValAndSetTarget",value:function(){var t=(r.target=this).getValue(this.expr);return r.target=null,t}},{key:"getValue",value:function(t){return t.split(".").reduce(function(t,e){return t[e]},this.vm.$data)}},{key:"update",value:function(){var t=this.value,e=this.getValue(this.expr);t!==e&&this.cb&&this.cb(e)}}]),i}(),l={updateText:function(t,e,n,i){e&&(e.textContent=t)},"t-model":function(t,e,n,i){var o=this;e&&(e.value=t),e.addEventListener("input",function(t){o.setVal(n.$data,i,t.target.value)})},"t-if":function(t,e,n,i){var o=window.getComputedStyle(e);e&&(e.style.display=t?o:"none")},"t-show":function(t,e,n,i){var o=window.getComputedStyle(e);e&&(e.style.visibility=t?o:"hidden")},"t-for":function(t,e,n,i){var o=3+i.indexOf("in"),s=i.slice(o),r=i.slice(0,o-4),a=this.getVal(n.$data,s),u=/\{\{([^}]+)\}\}/g;if(!Array.isArray(a))return console.warn("t-for value must be an array");var c=e.parentElement;c.removeChild(e);var f=e.cloneNode(!0);f.setAttribute("t-scope",s),f.setAttribute("t-itemname",r),f.removeAttribute("t-for"),f.setAttribute("t-index",0),f.setAttribute("is-t-for","true"),a.forEach(function(t,e){var n=f.cloneNode(!0);if(n.setAttribute("t-index",e),n.textContent){var i=n.textContent.match(/\{\{([^}]+)\}\}/)[1],o=Function("item","return "+i)(t);n.textContent=n.textContent.replace(u,o)}c.appendChild(n)})},setVal:function(t,e,n){var i=e.split(".");i.reduce(function(t,e){if(i.indexOf(e)!=i.length-1)return t[e];t[e]=n},t)},getVal:function(t,e){return e.split(".").reduce(function(t,e){return t[e]},t)}},e=["is-t-for","t-index","t-scope","t-itemname"],i=function(){function i(t,e){if(o(this,i),this.el=this.getDOM(t),this.vm=e,this.el){var n=this.toFragment(this.el);this.compile(n),this.el.appendChild(n)}else console.error("can not find element named "+t);this.vm.$el=this.el}return s(i,[{key:"compile",value:function(t){var n=this;t.childNodes.forEach(function(t,e){"CODE"!==t.tagName&&(n.isElement(t)?(n.compile(t),n.compileNode(t)):n.isText(t)&&n.compileText(t))})}},{key:"compileText",value:function(e){var n=this,t=/\{\{([^}]+)\}\}/g,i=e.textContent;if(t.test(i))if(e.parentElement.getAttribute("t-for")||e.parentElement.getAttribute("is-t-for"));else{var o=i.replace(t,function(){return new a(n.vm,1<arguments.length?arguments[1]:void 0,function(t){l.updateText(t,e,n.vm)}),1<arguments.length?arguments[1]:void 0}),s=this.splitData(o,this.vm.$data);l.updateText(s,e,this.vm)}}},{key:"splitData",value:function(t,e){return(t&&t.split(".")).reduce(function(t,e){return t[e]},e)}},{key:"compileNode",value:function(u){var c=this,t=u.getAttributeNames();if(t.filter(function(t){return c.isDirective(t)&&!c.isTFocus(t)}).forEach(function(t){var e=u.getAttribute(t),n=c.splitData(e,c.vm.$data);l[t]?l[t](n,u,c.vm,e):c.isPrivateDirective(t)||c.isEventBinding(t)||console.warn("can't find directive "+t)}),t.includes("t-index")){var e=u.getAttribute("t-index");u.setAttribute("tabindex",this.vm.focuser.tid),this.vm.focuser.addFocusMap(e,u)}t.filter(this.isEventBinding).forEach(function(t){var n=u.getAttribute(t),e=t.slice(1),i=/\(([^)]+)\)/,o=i.test(n),s=n.replace(i,""),r=c.splitData(s,c.vm.methods);if(u.getAttribute("is-t-for"))u.parentElement.addEventListener(e,function(t){if(t.target.getAttribute("is-t-for"))if(o){n.match(i)[1].split(",").map(function(t){return c.splitData(t.trim(),c.vm.$data)});var e=c.splitData(t.target.getAttribute("t-scope"),c.vm.$data)[t.target.getAttribute("t-index")];r.call(c.vm,e)}else r.call(c.vm)});else if(o){var a=n.match(i)[1].split(",").map(function(t){return c.splitData(t.trim(),c.vm.$data)});u.addEventListener(e,r.bind.apply(r,[c.vm].concat(f(a))))}else u.addEventListener(e,r.bind(c.vm))})}},{key:"isPrivateDirective",value:function(t){return e.includes(t)}},{key:"isEventBinding",value:function(t){return/^@/.test(t)}},{key:"isDirective",value:function(t){return t.includes("t-")}},{key:"isTFocus",value:function(t){return"t-index"===t}},{key:"getDOM",value:function(t){return this.isElement(t)?t:document.querySelector(t)||null}},{key:"isElement",value:function(t){return 1===t.nodeType}},{key:"isText",value:function(t){return 3===t.nodeType}},{key:"toFragment",value:function(t){for(var e=document.createDocumentFragment(),n=void 0;n=t.firstChild;)e.appendChild(n);return e}}]),i}(),u=function(t,e,n,i){console.log("blankfn")},c={circle:{horizontal:!1,vertical:!1},keysMap:{up:{codes:[38,104],handler:u},down:{codes:[40,98],handler:u},left:{codes:[37,100],handler:u},right:{codes:[39,102],handler:u},enter:{codes:[13,32],handler:u},space:{codes:[32],handler:u},home:{codes:[36],handler:u},menu:{codes:[18],handler:u},return:{codes:[27],handler:u},addVolume:{codes:[175],handler:u},subVolume:{codes:[174],handler:u}},keysMapMergeCoverage:!1},h=function(){function n(t,e){o(this,n),this.tid=0,this.init(t,e),this.bindKeyEvent()}return s(n,[{key:"init",value:function(t,e){var n=this;this.focusElementMap={},this.indexMap=[],this.focusOptions=Object.assign({},c,e.focus);var i=void 0,o=void 0;if(this.focusOptions.defaultFocusIndex){var s=e.focus&&e.focus.defaultFocusIndex.split("-");i=+s[0],o=+s[1]}this.focusState={currentIndexString:e.focus&&e.focus.defaultFocusIndex||"",currentRowIndex:i,currentColIndex:o},this.keysMap=this.focusOptions.keysMap,e.focus&&e.focus.keysMap&&(this.focusOptions.keysMapMergeCoverage?this.keysMap=Object.assign({},this.keysMap,e.focus.keysMap):Object.keys(this.keysMap).forEach(function(t){n.keysMap[t].codes=c.keysMap[t]?e.focus.keysMap[t].codes?[].concat(f(new Set(c.keysMap[t].codes.concat(e.focus.keysMap[t].codes)))):n.keysMap[t].codes:e.focus.keysMap[t].codes})),(t.focuser=this).vm=t}},{key:"execCommand",value:function(e){var n=this;Object.keys(this.keysMap).forEach(function(t){n.keysMap[t].codes.includes(e.keyCode)&&n.move(t,e)})}},{key:"bindKeyEvent",value:function(){window.addEventListener("keydown",this.keyDownHandler.bind(this))}},{key:"keyDownHandler",value:function(t){this.execCommand(t)}},{key:"addFocusMap",value:function(t,e){var n=this;this.tid++,t.split(/,\s*/).forEach(function(t){if(t in n.focusElementMap)return console.warn("t-focus should be unique in one TVVM page but t-focus="+t+" has already exist");n.focusElementMap[t]=e})}},{key:"setFocus",value:function(t){if(t in this.focusElementMap){var e=t.split("-"),n=+e[0],i=+e[1];this.focusElementMap[t].focus(),this.focusState.currentIndexString=t,this.focusState.currentFocusElement=this.focusElementMap[t],this.focusState.currentRowIndex=n,this.focusState.currentColIndex=i}}},{key:"generateIndexMap",value:function(){var o=this;Object.keys(this.focusElementMap).forEach(function(t){var e=t.split("-"),n=e[0],i=e[1];void 0===o.indexMap[n]?o.indexMap[n]=[i]:o.indexMap[n].push(i)}),this.indexMap=this.indexMap.map(function(t){return t.sort(function(t,e){return t-e})}),void 0!==this.focusOptions.defaultFocusIndex?this.setFocus(this.focusOptions.defaultFocusIndex):0!==this.indexMap.length?this.setFocus([0,this.indexMap[0][0]].join("-")):window.removeEventListener("keydown",this.keyDownHandler)}},{key:"isBoundary",value:function(){}},{key:"isTopBoundary",value:function(){var t=this.focusState.currentRowIndex,e=this.focusState.currentColIndex;if(0===t)return!0;for(var n=[--t,e].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[--t,e].join("-");return 0>=++t}},{key:"isLeftBoundary",value:function(){var t=this.focusState.currentRowIndex,e=this.focusState.currentColIndex;if(e===this.indexMap[t][0])return!0;for(var n=[t,--e].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[t,--e].join("-");return this.indexMap[t][0]>=++e}},{key:"isRightBoundary",value:function(){var t=this.focusState.currentRowIndex,e=this.focusState.currentColIndex;if(e===this.indexMap[t][this.indexMap[t].length-1])return!0;for(var n=[t,++e].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[t,++e].join("-");return--e>=this.indexMap[t][this.indexMap[t].length-1]}},{key:"isBottomBoundary",value:function(){var t=this.focusState.currentRowIndex,e=this.focusState.currentColIndex;if(t===this.indexMap.length-1)return!0;for(var n=[++t,e].join("-");this.focusElementMap[n]&&this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[n];)n=[++t,e].join("-");return--t>=this.indexMap.length-1}},{key:"moveUp",value:function(t,e,n){if(this.keysMap.up.handler&&this.keysMap.up.handler(t,e,n),this.isTopBoundary()){if(this.focusOptions.circle.vertical)this.setFocus([this.indexMap.length-1,this.focusState.currentColIndex].join("-"))}else{for(var i=this.focusState.currentRowIndex-1,o=this.focusState.currentColIndex,s=[i,o].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[s];)s=[--i,o].join("-");this.setFocus(s=[i,o].join("-"))}}},{key:"moveDown",value:function(t,e,n){if(this.keysMap.down.handler&&this.keysMap.down.handler(t,e,n),this.isBottomBoundary()){if(this.focusOptions.circle.vertical){this.setFocus([0,this.focusState.currentColIndex].join("-"))}}else{for(var i=this.focusState.currentRowIndex+1,o=this.focusState.currentColIndex,s=[i,o].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[s];)s=[++i,o].join("-");this.setFocus(s=[i,o].join("-"))}}},{key:"moveLeft",value:function(t,e,n){if(this.keysMap.left.handler&&this.keysMap.left.handler(t,e,n),this.isLeftBoundary()){if(this.focusOptions.circle.horizontal){var i=this.focusState.currentRowIndex;this.setFocus([i,this.indexMap[i][this.indexMap[i].length-1]].join("-"))}}else{for(var o=this.focusState.currentRowIndex,s=this.focusState.currentColIndex-1,r=[o,s].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[r];)r=[o,--s].join("-");this.setFocus(r=[o,s].join("-"))}}},{key:"moveRight",value:function(t,e,n){if(this.keysMap.right.handler&&this.keysMap.right.handler(t,e,n),this.isRightBoundary()){if(this.focusOptions.circle.horizontal){var i=this.focusState.currentRowIndex;this.setFocus([i,this.indexMap[i][0]].join("-"))}}else{for(var o=this.focusState.currentRowIndex,s=this.focusState.currentColIndex+1,r=[o,s].join("-");this.focusElementMap[this.focusState.currentIndexString]===this.focusElementMap[r];)r=[o,++s].join("-");this.setFocus(r=[o,s].join("-"))}}},{key:"move",value:function(t,e){Object.assign({},this.keysMap,{up:{handler:this.moveUp},down:{handler:this.moveDown},left:{handler:this.moveLeft},right:{handler:this.moveRight}})[t].handler.call(this,e,this.focusState.currentFocusElement,this.focusState.currentIndexString)}}]),n}(),d=function(){function n(t,e){o(this,n),this.hooks={},this.init(t,e),e.lifecycle=this,e.callHook=this.callHook.bind(this)}return s(n,[{key:"init",value:function(t,n){var i={beforeCreate:t.beforeCreate,created:t.created,beforeMount:t.beforeMount,mounted:t.mounted,beforeUpdate:t.beforeUpdate,updated:t.updated,beforeDestory:t.beforeDestory,destoried:t.destoried};Object.keys(i).forEach(function(t,e){void 0===i[t]&&(i[t]=p),i[t]=i[t]instanceof Function?i[t].bind(n):(console.warn("lifecycle hooks must be a function"),p)}),this.hooks=i}},{key:"callHook",value:function(t){this.hooks[t]()}}]),n}();function p(){}return function(){function e(t){o(this,e),new h(this,t),new d(t,this),this.callHook("beforeCreate"),this.$data="function"==typeof t.data?t.data():t.data,this.methods=t.methods,this.proxy(this.$data,this),this.proxy(t.methods,this),t.el&&(new n(this.$data),this.callHook("created"),this.callHook("beforeMount"),new i(t.el,this),this.focuser.generateIndexMap(),this.callHook("mounted"))}return s(e,[{key:"proxy",value:function(n,i){Object.keys(n).forEach(function(e){Object.defineProperty(i,e,{enumerable:!0,configurable:!0,get:function(){return n[e]},set:function(t){void 0!==i[e]&&console.warn("key "+e+" has already in Target"),n[e]=t}})})}}]),e}()});